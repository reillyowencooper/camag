#! /usr/bin/env python3 
# -*- coding: utf-8

import os, subprocess, shutil, logging, sys
from collections import defaultdict
import pandas as pd
from Bio import SeqIO
from src.cov import MagCov
from src.gc import MagGC
from src.tax import MagTaxonomy
from src.tetranuc import MagTetranuc
from src.scg import MagSCG
import src.utilities as utils
import src.file_handling as filehandling

__author__ = "Reilly Cooper"
__maintainer__ = "Reilly Cooper"
__email__ = "reilly.owen.cooper@gmail.com"
__version__ = "0.0.1"
__description__ = "Remove contaminant contigs from a metagenome-assembled genome"


def check_dependencies():
    dependencies_list = ['prodigal', 'hmmsearch', 'mmseqs']
    for executable in dependencies_list:
        filehandling.does_program_exist(executable)
        
def create_tmp_dir(tmpdir):
    utils.create_dir("tmp")

def check_tax_db():
    pass # TODO: Write func to check Swissprot MMSeqs is present

def rank_suspicion(gc_list, cov_list, tax_list, tetra_list):
    '''Weights suspicion of contigs based on how many lists they appear in
    Lists include GC content, coverage, taxonomy (Phylum), and tetranucleotide freq
    '''
    # This is probably the dumbest way to rank contigs, 
    # but I'm tired and can't think of anything better
    sus_dict = defaultdict(int)
    checked_items = []
    for item in gc_list:
        sus_dict[item] += 1
        if item in cov_list:
            sus_dict[item] += 1
        elif item in tax_list:
            sus_dict[item] += 1
        elif item in tetra_list:
            sus_dict[item] += 1
        checked_items.append(item)
    updated_cov_list = [x for x in cov_list if x not in checked_items]
    for item in updated_cov_list:
        sus_dict[item] += 1
        if item in tax_list:
            sus_dict[item] += 1
        elif item in tetra_list:
            sus_dict[item] += 1
        checked_items.append(item)
    updated_tax_list = [x for x in tax_list if x not in checked_items]
    for item in updated_tax_list:
        sus_dict[item] += 1
        if item in tetra_list:
            sus_dict[item] += 1
        checked_items.append(item)
    updated_tetra_list = [x for x in tetra_list if x not in checked_items]
    for item in updated_tetra_list:
        sus_dict[item] += 1
    return sus_dict

def get_consensus_contigs(mag, bam, taxdb,
                          tmpdir, outdir):
    mag_name = os.path.splitext(os.path.basename(mag))[0]
    gc = MagGC(mag, outdir)
    cov = MagCov(mag, bam, outdir)
    tax = MagTaxonomy(mag, outdir)
    tetra = MagTetranuc(mag, outdir)
    gc.run()
    cov.run()
    tax.run(taxdb, tmpdir)
    tetra.run()
    gc_df = pd.read_csv(mag_name + "_err_gc.csv")
    gc_contigs = gc_df['Contig'].tolist()
    cov_df = pd.read_csv(mag_name + "_err_cov.csv")
    cov_contigs = cov_df['Contig'].tolist()
    tax_df = pd.read_csv(mag_name + "_err_tax.csv")
    tax_contigs = tax_df['Contig'].tolist()
    tetra_df = pd.read_csv(mag_name + "err_tetra.csv")
    tetra_contigs = tetra_df['Contig'].tolist()
    ranked_contigs = rank_suspicion(gc_contigs, cov_contigs,
                                    tax_contigs, tetra_contigs)
    return ranked_contigs

# Check if contaminating contigs have any single-copy genes. In many cases, they won't, which is why they were not picked up as contamination
def check_scgs(mag, scg_db, outdir, ranked_contig_dict):
    mag_name = os.path.splitext(os.path.basename(mag))[0]
    highly_suspicious_contigs = []
    for contig_name, sus_rank in ranked_contig_dict.items():
        if sus_rank >= 3:
            highly_suspicious_contigs.append(contig_name)
    scg = MagSCG(mag, scg_db, outdir)
    scg.run()
    scg_df = pd.read_csv(mag_name + "_err_scg.csv")
    scg_contigs_list = [item for item in scg_df['Contig Names'].tolist()].unique()
    for sus_contig in highly_suspicious_contigs:
        for contig in scg_contigs_list:
            if sus_contig == contig:
                ranked_contig_dict[sus_contig] += 1
            else:
                ranked_contig_dict[contig] += 1
    return ranked_contig_dict
                
    
def remove_sus_contigs(mag, ranked_contig_dict, outdir, minimum_suspicion=3):
    outfile = os.path.join(outdir, os.path.basename(mag))
    for contig_name, sus_rank in ranked_contig_dict.items():
        if sus_rank >= minimum_suspicion:
            for seqrecord in SeqIO.parse(mag, "fasta"):
                seq_name = seqrecord.id
                if not seq_name == contig_name:
                    with open(outfile, 'w') as newmag:
                        newmag.write('>' + str(seq_name) + '\n' + str(seqrecord.seq) + '\n')

 
def main():
    pass